{% extends 'base.html' %}
{% block style %}
    <style>
        .btn_cust{
            height: 40px;
            width: 40px;
            border-radius: 0;
            border-color: #1b1e21;
            border-style: solid;
        }
        .btn_cust.active.focus,
        .btn_cust.active:focus,
        .btn_cust.focus,
        .btn_cust.focus:active,
        .btn_cust:active:focus,
        .btn_cust:focus {
            box-shadow: none  !important;
        }
    </style>
{% endblock %}
{% block title %}Place Ships{% endblock %}

{% block content %}
    <nav class="navbar navbar-expand-md bg-dark navbar-dark justify-content-center"> <span class="btn btn-warning">Battleship</span> </nav>
    <div class="container">
        <br>
        <div class="row">
            <div id="board1_container" class="col-6"></div>
            <div id="board2_container" class="col-6"></div>
        </div>
        <div class="row">
            <div id="chat_container"></div>
        </div>
    </div>
    {% load static %}
    <script>
        var counts=Array(6).fill(0);
        var upperCount=Array(6).fill(0);
        var activePlayerisMe=false;
        upperCount[1]=3;
        upperCount[2]=2;
        upperCount[3]=1;
        upperCount[4]=1;
        upperCount[5]=1;
        let socket = new WebSocket('ws://' + window.location.host + '/game/');
        let b1;
        let b2;
        socket.onopen = function open() {console.log('WebSockets connection created.')
        socket.send(JSON.stringify({
                'type': 'chat_message',
                'purpose': 'Set Game ID',
                'game_id': {{ room_name }},
                'from':'{{ user.username }}'
            }));};
        if (socket.readyState === WebSocket.OPEN) {
            socket.onopen();
        }
        socket.onmessage = function message(event) {
            var data = JSON.parse(event.data);
            if('game_id' in data && data['game_id']==={{ room_name }}) {
                if (data['purpose'] === 'Left Game') {
                    if (data['from'] ==='{{ user.username }}') {
                        alert("Your socket got disconnected. You're being redirected to your profile.");
                    } else {
                        alert("Your opponent disconnected. Redirecting to profile page.");
                        //Fix it to 'you won' when we fix code
                        //Add scoring code here
                    }
                    window.location.href = '/pairing/profile';
                }
                if(data['purpose']==='Initialize Game'){
                    b1.updateState(data);
                    b2.updateState(data);
                }
            }
        };
        function Square(props) {
            return React.createElement(
                'button',
                {
                    onClick: props.onClick,
                    className: 'square btn btn_cust '+props.value,
                },
                null,
            );
        }
        class Board extends React.Component {
            constructor(props) {
                super(props);
                var x = new Array(10);
                var y= new Array(6);
                let z=new Array(6);
                let a=jQuery.extend(true, {}, upperCount);
                for (var i = 0; i < x.length; i++) {
                    x[i] = new Array(10);
                }
                for(let i=1;i<y.length;i++){
                    y[i]=[];
                    z[i]=[];
                }
                this.state = {
                    squares: x.fill(Array(10).fill(0)),
                    iOfSquaresOfType: y,
                    jOfSquaresOfType: z,
                    myBoard: props.myBoard,
                    noOfSunkShips: 0,
                    squaresLeft: a,
                    activeBoard: false,
                };
            }
            updateState(data){
                if((this.state.myBoard && data['p1']==='{{ user.username }}') ||
                    (!this.state.myBoard && data['p2']==='{{ user.username }}')){
                    this.setState({
                        squares: event['p1squares'],
                        iOfSquaresOfType: event['p1iOfSquaresOfType'],
                        jOfSquaresOfType: event['p1jOfSquaresOfType'],
                        noOfSunkShips: event['p1noOfSunkShips'],
                        squaresLeft: event['p1squaresLeft'],
                        activeBoard: event['p1activePlayerIs1'] ? true : false ,
                    })
                }else if((this.state.myBoard && data['p2']==='{{ user.username }}') ||
                    (!this.state.myBoard && data['p1']==='{{ user.username }}')){
                    this.setState({
                        squares: event['p2squares'],
                        iOfSquaresOfType: event['p2iOfSquaresOfType'],
                        jOfSquaresOfType: event['p2jOfSquaresOfType'],
                        noOfSunkShips: event['p2noOfSunkShips'],
                        squaresLeft: event['p2squaresLeft'],
                        activeBoard: event['p1activePlayerIs1'] ? false : true ,
                    })
                }
            }
            handleClick(j, i) {
                let squares=jQuery.extend(true, {}, this.state.squares);
                let iOfSquaresOfType=jQuery.extend(true, {}, this.state.iOfSquaresOfType);
                let jOfSquaresOfType=jQuery.extend(true, {}, this.state.jOfSquaresOfType);
                let c=$('#s'+prev);
                if(c.length> 0){
                    let choice=c[0];
                    let shape=choice.value;
                    let orientation=(c.data('orientationv'))||1;
                    let ret=true;
                    let xToCheck=[];
                    let yToCheck=[];
                    xToCheck.push(i);
                    yToCheck.push(j);
                    if(shape==='1'){
                    }else if(shape==='2'){
                        xToCheck.push(i+(orientation-3)*(orientation%2-1));
                        yToCheck.push(j+(orientation-2)*(orientation%2));
                    }else if(shape==='3'){
                        xToCheck.push(i);
                        yToCheck.push(j- (((orientation===1)||(orientation===4))?1:0) + (((orientation===2)||(orientation===3))?1:0));
                        xToCheck.push(i+(((orientation===1)||(orientation===2))?1:0) - (((orientation===3)||(orientation===4))?1:0));
                        yToCheck.push(j);
                    }else if(shape==='4'){
                        if(orientation%2===1){
                            for(let k=1;k<=3;k++){
                                xToCheck.push(i);
                                yToCheck.push(j-(k)*(2-orientation));
                            }
                        }
                        if(orientation%2===0){
                            for(let k=1;k<=3;k++){
                                xToCheck.push(i+(k)*(3-orientation));
                                yToCheck.push(j);
                            }
                        }
                    }else if(shape==='5'){
                        if(orientation%2===1){
                            xToCheck.push(i+1);
                            xToCheck.push(i-1);
                            yToCheck.push(j);
                            yToCheck.push(j);
                            for(let k=1;k<=2;k++){
                                xToCheck.push(i);
                                yToCheck.push(j-(k)*(2-orientation));
                            }
                        }
                        if(orientation%2===0){
                            xToCheck.push(i);
                            xToCheck.push(i);
                            yToCheck.push(j+1);
                            yToCheck.push(j-1);
                            for(let k=1;k<=2;k++){
                                xToCheck.push(i+(k)*(3-orientation));
                                yToCheck.push(j);
                            }
                        }
                    }
                    for(let k=0;k<xToCheck.length;k++){
                        if(xToCheck[k]>9 || xToCheck[k]<0 || yToCheck[k]>9 || yToCheck[k]<0
                            || squares[yToCheck[k]][xToCheck[k]]===1){
                            ret=false;
                        }
                    }
                    if(ret&&counts[shape]<upperCount[shape]) {
                        counts[shape]++;
                        for(let k=0;k<xToCheck.length;k++){
                            squares[yToCheck[k]][xToCheck[k]]=1;
                            iOfSquaresOfType[shape].push(yToCheck[k]);
                            jOfSquaresOfType[shape].push(xToCheck[k]);
                        }
                        this.setState({
                            squares: squares,
                            iOfSquaresOfType: iOfSquaresOfType,
                            jOfSquaresOfType: jOfSquaresOfType,
                        });
                    }
                }
            }
            renderSquare(i, j) {
                let k = 10 * i + j;
                let type=0;
                //console.log(this.state.jOfSquaresOfType);
                //console.log(this.state.iOfSquaresOfType);
                for(let k1=1;k1<=5;k1++){
                    for(let k2=0;k2<this.state.iOfSquaresOfType[k1].length;k2++) {
                        // console.log(this.state.iOfSquaresOfType[k1]===i);
                        if (this.state.iOfSquaresOfType[k1][k2] === i && this.state.jOfSquaresOfType[k1][k2] === j) {
                            console.log("E");
                            type = k1;
                        }
                    }
                }
                let colour = 'btn-defaul{t';
                if (this.state.squares[i][j] === 1) {
                    if(type===0){
                        colour='btn-secondary';
                    }
                    else if(type===1){
                        colour = 'btn-success';
                    }
                    else if(type===2){
                        colour = 'btn-primary';
                    }
                    else if(type===3){
                        colour = 'btn-warning';
                    }
                    else if(type===4){
                        colour = 'btn-info';
                    }
                    else if(type===5){
                        colour = 'btn-danger';
                    }
                }
                return React.createElement(Square, {
                    value: colour,
                    onClick: () => this.handleClick(i, j),
                    key: k,
                });
            }
            render() {
                let rows = [];
                for (let i = 0; i < 10; i++) {
                    for (let j = 0; j < 10; j++) {

                        // note: we add a key prop here to allow react to uniquely identify each
                        // element in this array. see: https://reactjs.org/docs/lists-and-keys.html
                        rows.push(this.renderSquare(i, j));
                    }
                    rows.push(React.createElement(
                        'br',
                        {
                            key: 'b'+i.toString(),
                        },
                    ));
                }
                return React.createElement(
                    'div',
                    null,
                    rows
                );
            }
        }
        b1=React.createElement(Board,{
            myBoard: true,
        });
        b2=React.createElement(Board,{
           myBoard: false,
        });
        ReactDOM.render(b1, document.getElementById('board1_container'));
        ReactDOM.render(b2,document.getElementById('board2_container'));
    </script>
{% endblock %}
