{% extends 'base.html' %}
{% block style %}
    <style>
        .btn_cust{
            height: 40px;
            width: 40px;
            border-radius: 0;
            border-color: #1b1e21;
            border-style: solid;
        }
        .btn_cust.active.focus,
        .btn_cust.active:focus,
        .btn_cust.focus,
        .btn_cust.focus:active,
        .btn_cust:active:focus,
        .btn_cust:focus {
            box-shadow: none  !important;
        }
    </style>
{% endblock %}
{% block title %}Place Ships{% endblock %}

{% block content %}
    <nav class="navbar navbar-expand-md bg-dark navbar-dark justify-content-center"> <span class="btn btn-warning">Battleship</span> </nav>
    <div class="container">
        <br>
        <div class="row">
            <div id="parent_container"></div>
        </div>
        <div class="row">
            <div id="chat_container"></div>
        </div>
    </div>
    {% load static %}
    <script>
        var counts=Array(6).fill(0);
        var upperCount=Array(6).fill(0);
        var activePlayerisMe=false;
        upperCount[1]=3;
        upperCount[2]=2;
        upperCount[3]=1;
        upperCount[4]=1;
        upperCount[5]=1;
        function Square(props) {
            return React.createElement(
                'button',
                {
                    onClick: props.onClick,
                    className: 'square btn btn_cust '+props.value,
                },
                null,
            );
        }
        class Board extends React.Component {
            constructor(props) {
                super(props);
                this.myBoard= props.myBoard;
                var x = new Array(10);
                var y= new Array(6);
                let z=new Array(6);
                let a=jQuery.extend(true, {}, upperCount);
                for (var i = 0; i < x.length; i++) {
                    x[i] = new Array(10);
                }
                for(let i=1;i<y.length;i++){
                    y[i]=[];
                    z[i]=[];
                }
                this.state = {
                    squares: x.fill(Array(10).fill(0)),
                    iOfSquaresOfType: y,
                    jOfSquaresOfType: z,
                    noOfSunkShips: 0,
                    squaresLeft: a,
                    activeBoard: false,
                };
            }
            handleClick(j, i) {

            }
            renderSquare(i, j) {
                let k = 10 * i + j;
                let type=0;
                //console.log(this.state.jOfSquaresOfType);
                //console.log(this.state.iOfSquaresOfType);
                for(let k1=1;k1<=5;k1++){
                    for(let k2=0;k2<this.state.iOfSquaresOfType[k1].length;k2++) {
                        // console.log(this.state.iOfSquaresOfType[k1]===i);
                        if (this.state.iOfSquaresOfType[k1][k2] === i && this.state.jOfSquaresOfType[k1][k2] === j) {
                            console.log("E");
                            type = k1;
                        }
                    }
                }
                let colour = 'btn-default';
                if (this.state.squares[i][j] === 1) {
                    if(type===0){
                        colour='btn-secondary';
                    }
                    else if(type===1){
                        colour = 'btn-success';
                    }
                    else if(type===2){
                        colour = 'btn-primary';
                    }
                    else if(type===3){
                        colour = 'btn-warning';
                    }
                    else if(type===4){
                        colour = 'btn-info';
                    }
                    else if(type===5){
                        colour = 'btn-danger';
                    }
                }
                return React.createElement(Square, {
                    value: colour,
                    onClick: () => this.handleClick(i, j),
                    key: k,
                });
            }
            render() {
                let rows = [];
                console.log(this.myBoard,this.state.iOfSquaresOfType);
                for (let i = 0; i < 10; i++) {
                    for (let j = 0; j < 10; j++) {

                        // note: we add a key prop here to allow react to uniquely identify each
                        // element in this array. see: https://reactjs.org/docs/lists-and-keys.html
                        rows.push(this.renderSquare(i, j));
                    }
                    rows.push(React.createElement(
                        'br',
                        {
                            key: 'b'+i.toString(),
                        },
                    ));
                }
                return React.createElement(
                    'div',
                    {
                        className:'col-6',
                    },
                    rows
                );
            }
        }
        class Parent extends React.Component {
            constructor(props) {
                super(props);
            }
            updateState(boardref,data){
                if((boardref.myBoard && data['p1']==='{{ user.username }}') ||
                    (!boardref.myBoard && data['p2']==='{{ user.username }}')){
                    alert(data['purpose']);
                    boardref.setState({
                        squares: data['p1squares'],
                        iOfSquaresOfType: data['p1iOfSquaresOfType'],
                        jOfSquaresOfType: data['p1jOfSquaresOfType'],
                        noOfSunkShips: data['p1noOfSunkShips'],
                        squaresLeft: data['p1squaresLeft'],
                        activeBoard: data['p1activePlayerIs1'] ? true : false ,
                    });
                }else if((boardref.myBoard && data['p2']==='{{ user.username }}') ||
                    (!boardref.myBoard && data['p1']==='{{ user.username }}')){
                    alert("S2");
                    boardref.setState({
                        squares: data['p2squares'],
                        iOfSquaresOfType: data['p2iOfSquaresOfType'],
                        jOfSquaresOfType: data['p2jOfSquaresOfType'],
                        noOfSunkShips: data['p2noOfSunkShips'],
                        squaresLeft: data['p2squaresLeft'],
                        activeBoard: data['p1activePlayerIs1'] ? false : true ,
                    });
                }
                this.setState({

                });
            }
            componentDidMount() {
                this.socket = new WebSocket('ws://' + window.location.host + '/game/');
                if (this.socket.readyState === WebSocket.OPEN) {
                    this.socket.onopen();
                }
                this.socket.onopen = () => {
                    console.log('WebSockets connection created.');
                    this.socket.send(JSON.stringify({
                        'type': 'chat_message',
                        'purpose': 'Set Game ID',
                        'game_id': {{ room_name }},
                        'from': '{{ user.username }}'
                    }));
                };
                this.socket.onmessage = (event) => {
                    var data = JSON.parse(event.data);
                    if ('game_id' in data && data['game_id'] ==={{ room_name }}) {
                        if (data['purpose'] === 'Left Game') {
                            if (data['from'] === '{{ user.username }}') {
                                alert("Your socket got disconnected. You're being redirected to your profile.");
                            } else {
                                alert("Your opponent disconnected. Redirecting to profile page.");
                                //Fix it to 'you won' when we fix code
                                //Add scoring code here
                            }
                            window.location.href = '/pairing/profile';
                        }
                        if (data['purpose'] === 'Initialize Game') {
                            this.updateState(this.board1,data);
                            this.updateState(this.board2,data);
                        }
                    }
                };
            }

            render() {
                let rows = [];
                rows.push(React.createElement(
                    Board,
                    {
                        key: 'b1',
                        myBoard: true,
                        ref: (board1) => {
                            this.board1 = board1
                        },

                    }
                ));
                rows.push(React.createElement(
                    Board,
                    {
                        key: 'b2',
                        myBoard: false,
                        ref: (board2) => {
                            this.board2 = board2
                        },

                    }
                ));
                return React.createElement(
                    'div',
                    {
                        className: 'row',
                    },
                    rows
                );
            }
        }
        let p=React.createElement(
            Parent,
            null,
        );
        ReactDOM.render(p,document.getElementById('parent_container'));
    </script>
{% endblock %}
